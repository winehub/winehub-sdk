build-runtime: true

id: online.winehub.Sdk
id-platform: online.winehub.Platform
branch: 1.6

runtime: org.freedesktop.Platform
runtime-version: 1.6
sdk: org.freedesktop.Sdk

add-extensions:
   online.winehub.Platform.Compat32:
      directory: lib/32bit
      version: 1.6
      versions: 1.6
      add-ld-path: lib
      subdirectories: false
      autodelete: false
      no-autodownload: false

   online.winehub.Platform.Wine32:
      directory: lib/wine32
      version: 1.6
      versions: 1.6
      add-ld-path: lib
      subdirectories: false
      autodelete: false

    online.winehub.Platform.Wine64:
      directory: lib/wine64
      version: 1.6
      versions: 1.6
      add-ld-path: lib
      subdirectories: false
      autodelete: false

   online.winehub.Platform.Extension:
      directory: lib/extension
      version: 1.6
      subdirectories: true
      autodelete: true
      no-autodownload: true

   online.winehub.Sdk.Extension:
      directory: lib/sdk
      version: 1.6
      subdirectories: true
      autodelete: true
      no-autodownload: true

platform-extensions:
   - org.freedesktop.Platform.Locale

inherit-extensions:
   - org.freedesktop.Platform.GL
   - org.freedesktop.Platform.Timezones
   - org.freedesktop.Platform.GStreamer
   - org.freedesktop.Platform.VAAPI.Intel
   - org.freedesktop.Sdk.Extension

finish-args:
   - --sdk=online.winehub.Sdk//1.6
   - --runtime=online.winehub.Platform//1.6
   - --allow=multiarch
   - --env=WINEDEBUG=-all
   - --env=WINEPREFIX=/var/data/wine

cleanup:
   - /man
   - /share/man

cleanup-commands:
   - /usr/libexec/freedesktop-post.sh

cleanup-platform-commands:
   - /usr/libexec/freedesktop-post.sh

build-options:
  cflags: -O2 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2
  cxxflags: -O2 -g -fstack-protector-strong -D_FORTIFY_SOURCE=2
  ldflags: -fstack-protector-strong -Wl,-z,relro,-z,now
  env:
    V: '1'

modules:
   - name: platform-setup
     buildsystem: simple
     build-commands:
       - mkdir -p /usr/lib/extension
       - mkdir -p /usr/lib/sdk
       - mkdir -p /usr/lib/wine32
       - mkdir -p /usr/lib/wine64

   - name: platform-setup-compat32
     buildsystem: simple
     build-commands:
        - mkdir -p /usr/lib/32bit
        - mkdir -p /usr/lib/32bit/extension
        - mkdir -p /usr/lib/32bit/sdk
     only-arches: 
      - x86_64

   - name: llvm6
     buildsystem: "cmake-ninja"
     builddir: true
     cleanup: "/lib/llvm6"
     build-options:
        env:
           cflags: ""
           cxxflags: ""
           ldflags: ""
        prefix: "/usr/lib/llvm6"
     config-opts:
        - -DLLVM_TARGETS_TO_BUILD=X86;AMDGPU;NVPTX
        - -DLLVM_ENABLE_ASSERTIONS:BOOL=OFF
        - -DBUILD_SHARED_LIBS:BOOL=OFF
        - -DCMAKE_BUILD_TYPE=Release
        - -DLLVM_LIBDIR_SUFFIX=
        - -DLLVM_ENABLE_LIBCXX:BOOL=OFF
        - -DLLVM_ENABLE_ZLIB:BOOL=ON
        - -DLLVM_ENABLE_FFI:BOOL=ON
        - -DLLVM_INCLUDE_TESTS:BOOL=OFF
        - -DLLVM_BUILD_TOOLS:BOOL=ON
        - -DLLVM_INCLUDE_EXAMPLES:BOOL=OFF
        - -DLLVM_INCLUDE_UTILS:BOOL=OFF
        - -DLLVM_INCLUDE_DOCS:BOOL=OFF
        - -DLLVM_ENABLE_DOXYGEN:BOOL=OFF
        - -DLLVM_BUILD_EXTERNAL_COMPILER_RT:BOOL=ON
        - -DFFI_INCLUDE_DIR=/usr/lib/libffi-3.2.1/include
        - -DLLVM_INSTALL_TOOLCHAIN_ONLY:BOOL=OFF

     sources:
        - type: "archive"
          url: "http://llvm.org/releases/6.0.0/llvm-6.0.0.src.tar.xz"
          sha256: "1ff53c915b4e761ef400b803f07261ade637b0c269d99569f18040f3dcee4408"

   - name: metainfo
     buildsystem: simple
     build-commands:
        - mkdir -p /usr/share/appdata
        - install online.winehub.Platform.appdata.xml /usr/share/appdata
        - install online.winehub.Sdk.appdata.xml /usr/share/appdata
        - appstream-compose --basename=online.winehub.Platform --prefix=/usr --origin=flatpak online.winehub.Platform
        - appstream-compose --basename=online.winehub.Sdk --prefix=/usr --origin=flatpak online.winehub.Sdk
     sources:
        - type: file
          path: online.winehub.Sdk.appdata.xml
        - type: file
          path: online.winehub.Platform.appdata.xml


